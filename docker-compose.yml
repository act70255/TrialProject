name: cloudfilemanager

services:
  webapi:
    build:
      context: .
      dockerfile: docker/webapi.Dockerfile
    image: cloudfilemanager/webapi:latest
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      UseSwagger: "false"
      Cors__AllowedOrigins__0: http://localhost:5190
      Cors__AllowedOrigins__1: http://127.0.0.1:5190
      ConfigVersion: "1.0"
      Storage__StorageRootPath: /app/storage
      Database__Provider: Sqlite
      Database__MigrateOnStartup: "true"
      Database__ConnectionStrings__Sqlite: Data Source=/app/data/cloud-file-manager.db
      Output__XmlTarget: File
      Output__XmlOutputPath: /app/output/tree.xml
      ApiSecurity__HeaderName: X-Api-Key
      ApiSecurity__ApiKey: change-this-in-production
    volumes:
      - ./deploy/prod/storage:/app/storage
      - ./deploy/prod/data:/app/data
      - ./deploy/prod/output:/app/output
    ports:
      - "5181:8080"
    restart: unless-stopped
    networks:
      - cfm-net

  website:
    build:
      context: .
      dockerfile: docker/website.Dockerfile
      args:
        VITE_API_BASE_URL: http://localhost:5181
        VITE_API_KEY: change-this-in-production
    image: cloudfilemanager/website:latest
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      WebApiBaseUrl: http://webapi:8080/
      ApiSecurity__HeaderName: X-Api-Key
      ApiSecurity__ApiKey: change-this-in-production
    depends_on:
      - webapi
    ports:
      - "5190:8080"
    restart: unless-stopped
    networks:
      - cfm-net

  console:
    build:
      context: .
      dockerfile: docker/console.Dockerfile
    image: cloudfilemanager/console:latest
    environment:
      ConfigVersion: "1.0"
      Storage__StorageRootPath: /app/storage
      Database__Provider: Sqlite
      Database__MigrateOnStartup: "false"
      Database__ConnectionStrings__Sqlite: Data Source=/app/data/cloud-file-manager.db
      Output__XmlTarget: File
      Output__XmlOutputPath: /app/output/tree.xml
    volumes:
      - ./deploy/prod/storage:/app/storage
      - ./deploy/prod/data:/app/data
      - ./deploy/prod/output:/app/output
    stdin_open: true
    tty: true
    profiles:
      - console
    networks:
      - cfm-net

networks:
  cfm-net:
    driver: bridge
